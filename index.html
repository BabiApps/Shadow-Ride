<!DOCTYPE html>
<html>
<title>Shadow Ride W3</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">

<style>
  .backgroud {
    background-color: #336B90;
  }

  @media (max-width: 480px) {
    img {
      max-width: 100%;
      width: auto;
      height: auto;
    }
  }

  @media (min-width: 481px) {
    img {
      max-width: 42%;
      width: auto;
      height: auto;
    }
  }
  @media (max-width: 480px) {
   .pedding_section {
      padding-top: 10px;
      padding-bottom: 10px;
     
   }
}

@media (min-width: 481px) {
   .pedding_section {
      padding-left: 0;
      padding-right: 0;
   }
}
</style>

<body>

  <!-- Side Navigation -->
  <!--nav class="w3-sidebar w3-bar-block w3-card w3-animate-left w3-center" style="display:none" id="mySidebar">
  <h1 class="w3-xxxlarge w3-text-theme">Side Navigation</h1>
  <button class="w3-bar-item w3-button" onclick="w3_close()">Close <i class="fa fa-remove"></i></button>
  <a href="#" class="w3-bar-item w3-button">Link 1</a>
  <a href="#" class="w3-bar-item w3-button">Link 2</a>
  <a href="#" class="w3-bar-item w3-button">Link 3</a>
  <a href="#" class="w3-bar-item w3-button">Link 4</a>
</nav-->

  <!-- Header -->
  <header class="w3-container backgroud w3-padding" id="myHeader">
    <!--i onclick="w3_open()" class="fa fa-bars w3-xlarge w3-button w3-theme"></i-->
    <div class="w3-center">
      <img src="shadowRidePic.jpg" alt="shadowRidePic">
      <!-- <h1 class="w3-xxxlarge w3-animate-bottom">כותרת</h1>
    <div class="w3-padding-32">
      <button class="w3-btn w3-xlarge w3-dark-grey w3-hover-light-grey" onclick="document.getElementById('id01').style.display='block'" style="font-weight:900;">כפתור מתחת לכותרת</button>
    </div> -->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js"></script>
    <link rel="stylesheet" href="center-radar.css">

    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script-->
  </header>

  <!-- Modal -->
  <div id="id01" class="w3-modal">
    <div class="w3-modal-content w3-card-4 w3-animate-top">
      <header class="w3-container w3-theme-l1">
        <span onclick="document.getElementById('id01').style.display='none'"
          class="w3-button w3-display-topright">×</span>
        <h4>חלון קופץ בלחיצה על הכפתור מתחת לכותרת</h4>
        <h5>Because we can <i class="fa fa-smile-o"></i></h5>
      </header>
      <div class="w3-padding">
        <p>Cool huh? Ok, enough teasing around..</p>
        <p>Go to our <a class="w3-btn" href="/w3css/default.asp">W3.CSS Tutorial</a> to learn more!</p>
      </div>
      <footer class="w3-container w3-theme-l1">
        <p>Modal footer</p>
      </footer>
    </div>
  </div>

  <div class="w3-row-padding w3-margin-top">
    <div class="w3-third">
      <div class="w3-card w3-container" style="min-height:400px; padding-bottom: 10px;">
        <!--h3>ריבוע שמאלי</h3-->
        <!--br><i class="fa fa-desktop w3-margin-bottom w3-text-theme" style="font-size:120px"></i-->

        <h2>Input location</h2>
        <div class="w3-section">
          <input class="w3-input" type="number" step="0.00000001" id="lat" required>
          <label>Latitude</label>
        </div>
        <div class="w3-section">
          <input class="w3-input" type="number" step="0.00000001" id="lon" required>
          <label>Longtitude</label>
        </div>
        <div class="w3-section">
          <input class="w3-input" type="number" id="radius" value="20" required>
          <label>Radius (m)</label>
        </div>
        <br>
        
        <button class="w3-btn w3-dark-grey w3-hover-light-grey" onclick="getLocation()">Get my location</button>
        <button class="w3-btn w3-blue w3-hover-light-grey" onclick="findNearStops()">Find nearby bus stops</button>
        <!-- "document.getElementById('section2').style.display='block'" -->
        <!-- "document.getElementById('section2').style.display='none'" -->

      </div>
    </div>
   

    <!-- ##################################################################
  MAP
####################################################################### -->
    <div class="w3-third w3-center pedding_section" style="right: 0; ">
      <!--#################################################### 
        for right set: "position: absolute;"
      but it over the input section -->
      <div class="w3-card w3-container" id="mapInRight" style="min-height:400px">
      </div>
    </div>
    <!-- not in use script src="OpenLayers.js"></script-->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" />
    <!-- script for showing the map -->
    <script type="text/javascript">
      // Where you want to render the map.
      var element = document.getElementById('mapInRight');
      var pickMarker = null;

      // Height has to be set. You can do this in CSS too.
      //element.style = 'height:400px;';

      // Create Leaflet map on map element.
      var map = L.map(element);

      // Add OSM tile layer to the Leaflet map.
      L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Target's GPS coordinates.
      var target = L.latLng('31.8788761797386', '35.246309360500305');
      document.getElementById('lat').value = target['lat'];
      document.getElementById('lon').value = target['lng'];

      // Set map's center to target with zoom 14.
      map.setView(target, 14);

      map.on('click', addMarker);

      function addMarker(e) {
        // Add marker to map at click location; 
        if (pickMarker != null) {
          //map.removeLayer(oldMarker);
          pickMarker.setLatLng(e.latlng).update();  // Updates your defined marker position
        } else {
          pickMarker = new L.marker(e.latlng);
          pickMarker.addTo(map);
        }

        document.getElementById('lat').value = e.latlng['lat'];
        document.getElementById('lon').value = e.latlng['lng'];
      }

  // Place a marker on the same location.
  //L.marker(target).addTo(map);
    </script>

    

<!-- middle -->
    <div class="w3-third pedding_section" id="section2" style="display: none;">
      <div class="w3-card w3-container w3-center" style="min-height:400px">
        <h3 id=collapse_head></h3><br>
        <div id='list'></div>
        <br>
        <div id='listForTest'></div>
        <br>
        <div id='list_StopsInRoute'></div>
        <br>
        <div id='button_startCalc'></div>
        <br>
        <div id='showAnswer'></div>
        
      </div>
    </div>
  </div>

  <script src="./fun.js"></script>
  <script src="./suncalc.js"></script>
  <script>
    //globle varible
    var dataFile = [];
    var stopsData = [];
    var stopsData_temp = [];
    var rootAllFirstStopsID = [];
    var sortStops = []; // without geomrtry on road/line
    
    var nearbyStopMarker = L.featureGroup().addTo(map);
    var On_OffRoute = L.featureGroup().addTo(map);
    var stopOnRoute = L.featureGroup().addTo(map);
    // https://stackoverflow.com/a/39968118

    var busGetOn = L.icon({
            iconUrl: 'icons8-get-on-bus-100.png',
            iconSize:     [25, 25], // size of the icon
          });
    var busGetOff = L.icon({
      iconUrl: 'icons8-get-off-bus-100.png',
      iconSize:     [25, 25], // size of the icon
    });

    // find device location
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    function showPosition(position) {
      document.getElementById('lat').value = position.coords.latitude;
      document.getElementById('lon').value = position.coords.longitude;
      target = L.latLng(position.coords.latitude, position.coords.longitude);

      if (pickMarker != null) {
        //map.removeLayer(oldMarker);
        pickMarker.setLatLng(target).update();  // Updates your defined marker position
      } else {
        pickMarker = new L.marker(target);
        pickMarker.addTo(map);
      }
      map.setView(target, 14);
    }

    // ##################################################################################################################################
    // ##################################################################################################################################

    function calculatePerFullRoute() {
      
      var firstStopID, lastStopID;
      
      //find the first and last stop (to remove all stop out-line)
      var element_input = document.getElementById('stops');
      var element_datalist = document.getElementById('stops1');
      var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
      tempValue1 = opSelected.getAttribute('data-value');
      firstStopID = rootAllFirstStopsID[tempValue1];
      
      
      var element_input = document.getElementById('eStop');
      var element_datalist = document.getElementById('eStop1');
      var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
      lastStopID = opSelected.getAttribute('data-value');
      
      //console.log('First stop ID - ' + firstStopID);
      //console.log('Last stop ID - ' + lastStopID);


      
       

      var distanceR = 0, distanceL = 0, SumDistance_Air = 0, sumNull = 0;
      var cBus, diffC, persent, persentSide, sum_cBus = 0;

      // check the time for calcultion
      isDay = isDayNow(endStopLocation);

      if (isDay){
        for (var i = 0; i < stopsData_temp.length - 1; i++) {

          // start stop
          if ('stop' in stopsData_temp[i]) {
            startStop = stopsData_temp[i]["stop"]["geometry"]["coordinates"];
          }
          else {
            startStop = stopsData_temp[i];
          }

          // end stop
          if ('stop' in stopsData_temp[i + 1]) {
            endStop = stopsData_temp[i + 1]["stop"]["geometry"]["coordinates"];
          }
          else {
            endStop = stopsData_temp[i + 1];
          }


          distance_Air = distanceBetweenStops(startStop, endStop);
          SumDistance_Air += distance_Air;

          cBus = anglePer2stops(startStop, endStop);
    
          

          suncalcVar = SunCalc.getPosition(customDate, startStop[0], startStop[1]);
          cSun = suncalcVar['azimuth'] * 180 / Math.PI + 180;

          diffC = cSun - cBus;
          cBus_getSide = get_R_L_by_cBus(diffC);

          if (cBus_getSide == "Right") {
            distanceR += distance_Air;
          }
          else if (cBus_getSide == "Left") {
            distanceL += distance_Air;
          }
          else {
            sumNull++;
          }

          /*
          console.log('From: ' + stopsData_temp[i]['stop']['stop_name'] + ', To: ' + stopsData_temp[i + 1]['stop']['stop_name'] +
            '\nDistance ' + distance_Air +
            '\nCalc num: ' + (i + 1) + ", cSun is " + cSun + ", and cBus is " + cBus + ",getSide - " + cBus_getSide);

          */

        }
      
      
        console.log('-------\nSum M in Right: ' + distanceR + '\nSum M in Left: ' + distanceL + '\nUndefined: ' + sumNull);


        if (distanceR > distanceL) {
          persent = distanceR / SumDistance_Air;
          persentSide = "Right";
          persentSideNegativ = "Left";
        }
        else {
          persent = distanceL / SumDistance_Air;
          persentSide = "Left";
          persentSideNegativ = "Right";
        }

        x = { 'persent': Math.round(persent*100), 'persentSide': persentSide , 'persentSideNegativ': persentSideNegativ};

        if (i == 0) {
          document.getElementById('showAnswer').innerHTML = "Please choose another stop that isn't start"
          alert('Same Location! set another end stop.')
        } else {
          document.getElementById('showAnswer').innerHTML = `<p>${x["persent"]}% From the Route,\nThe SUN is on your ${x["persentSide"]} side.\nYou should sit on the ${x["persentSideNegativ"]} side</p>`;
        }
      }
      //if is not day (or error in compare)
      else{
        document.getElementById('showAnswer').innerHTML = "You can sit wherever you want"
      }
    }

    function routes(data) {
      //route_data = '';
      var routeList = [];
      for (i = 0; i < data['route_stops'].length; i++) {
        routeList.push(data["route_stops"][i]["route"]);//{'short':[data["route_stops"][i]["route"]["route_short_name"]],'long':data["route_stops"][i]["route"]["route_long_name"]};

        //route_data+=`<li><b>${data["route_stops"][i]["route"]["route_short_name"]}:</b> ${data["route_stops"][i]["route"]["route_long_name"]}</li>\n`;
      }
      return routeList;
    }

    function makeRoutesList() {
      
      var element_input = document.getElementById('stops');
      var element_datalist = document.getElementById('stops1');
      var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
      var val = opSelected.getAttribute('data-value');
      

      var x = `<label for="routes">Choose a Route: <input id="routes" list="routes1" onfocus="this.value=''" onChange="makeStopsInRoute()"></label>
                      <datalist name="routes" id="routes1">
                        <option value="" selected disabled hidden>Choose Route</option>`;//<option value="volvo">Volvo</option>


      var n = 0;
      while (n < dataFile[val].length) {
        // split long name
        route_long_name = dataFile[val][n]["route_long_name"];
        //console.log(route_long_name);
        end=route_long_name.slice(route_long_name.indexOf(">")+1, route_long_name.indexOf('#')-2);
        first=route_long_name.slice(0, route_long_name.indexOf('<'));
        routeNumber = route_long_name.slice(route_long_name.indexOf('#')-1)
        //console.log(routeNumber)
        
        

        x += `<option data-value="${dataFile[val][n]["id"]}" value="קו ${dataFile[val][n]["route_short_name"]}, מסלול ${routeNumber}">מ:${first}, לכיוון: ${end}</option>`;
        n++
      }
      x += `</datalist><br>`;
      document.getElementById('listForTest').innerHTML = x;
    }


    function makeStopsInRoute() {

      var element_input = document.getElementById('routes');
      var element_datalist = document.getElementById('routes1');
      var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
      var idOfRoute = opSelected.getAttribute('data-value');

      //var idOfRoute = document.getElementById('routes').value;
      var linkRoute = `https://transit.land/api/v2/rest/routes/${idOfRoute}?apikey=iMDAuMorfb5YN90M8fmjiswA5okKN0zX&format=geojson`;
      //console.log(linkRoute);

      // Instantiate an new XHR Object
      const xhr = new XMLHttpRequest();

      // Open an obejct (GET/POST, PATH,
      // ASYN-TRUE/FALSE)
      xhr.open("GET", linkRoute, true);

      // When response is ready
      xhr.onload = function () {
        if (this.status === 200) {

          // Changing string data into JSON Object
          obj = JSON.parse(this.responseText);
          stopsData = obj["features"][0]["properties"]["route_stops"];

          var x = `<label for="endstops">Choose a End Stop: <input id="eStop" list="eStop1" onfocus="this.value=''" onChange="showButtonForCalc()"></label>
                      <datalist name="eStop" id="eStop1">
                        <option value="" selected disabled hidden>Choose End Stop</option>`;

      
          var element_input = document.getElementById('stops');
          var element_datalist = document.getElementById('stops1');
          var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
          var tempValue1 = opSelected.getAttribute('data-value');

          firstStopID = rootAllFirstStopsID[tempValue1];

          //var stopOnRoute = L.featureGroup().addTo(map);
          map.removeLayer(nearbyStopMarker);

          
          var nearbyIcon = L.icon({
            iconUrl: 'icons8-marker-48inRoute.png',
            iconSize:     [20, 20], // size of the icon
          });
          

          // sorted
          sortedStops_withLine = sortStopsList(obj["features"][0]);

          
          var flag_firstStopID, sortStops_counter = 0, flag_firstStopID_inWithLine = 0;
          previusCoordinates=null;

          for (i = 0; i < sortedStops_withLine.length; i++) {
            if ('stop' in sortedStops_withLine[i]) {
              stop_info = sortedStops_withLine[i];
              sortStops.push(stop_info);
              sortStops_counter++;
              if (stop_info['stop']['id'] == firstStopID) {
                flag_firstStopID = sortStops_counter;
                flag_firstStopID_inWithLine = i;
                //console.log("Start stop: " + stop_info['stop']['stop_name']);
              }
              //console.log(i + ', Name - ' + stop_info['stop']['stop_name']);
            }
            else {
              coordinates = [sortedStops_withLine[i][1],sortedStops_withLine[i][0]];
              //[sortStops[n]["stop"]['geometry']['coordinates'][1],sortStops[n]["stop"]['geometry']['coordinates'][0]];
              if (i < sortedStops_withLine.length-1){
                if (previusCoordinates!=null){
                  //coordinates2 = [sortedStops_withLine[i+1][1],sortedStops_withLine[i+1][0]];
                  //[sortStops[n+1]["stop"]['geometry']['coordinates'][1],sortStops[n+1]["stop"]['geometry']['coordinates'][0]];
                  var line = new L.polyline([previusCoordinates, coordinates]);
                  stopOnRoute.addLayer(line);
                  
                }
                previusCoordinates = coordinates;
              } 
            }
          }

          //short the list from the seleced (start) stop
          sortStops.splice(0, flag_firstStopID - 1); // the (-1) for showing in the list the first stop
          sortedStops_withLine.splice(0, flag_firstStopID_inWithLine);
          

          // (OLD) stopsData = sortStops;
          stopsData = sortedStops_withLine;


          

          coordinates = [sortStops[0]["stop"]['geometry']['coordinates'][1],sortStops[0]["stop"]['geometry']['coordinates'][0]];          
          var getOn = new L.Marker(coordinates, {icon: busGetOn}).bindPopup(sortStops[0]["stop"]['stop_name']);
          //On_OffRoute.addLayer(getOn);
          coordinates = [sortStops[sortStops.length-1]["stop"]['geometry']['coordinates'][1],sortStops[sortStops.length-1]["stop"]['geometry']['coordinates'][0]];
          var getOff = new L.Marker(coordinates, {icon: busGetOff}).bindPopup(sortStops[sortStops.length-1]["stop"]['stop_name']);
          //On_OffRoute.addLayer(getOff);

          //map.fitBounds(On_OffRoute.getBounds());


          //stopData replaced with sortStops
          var n = 0;
          while (n < sortStops.length-1) {
            x += `<option data-value="${sortStops[n]["stop"]["id"]}" value="${sortStops[n]["stop"]["stop_name"]}">`;

            coordinates = [sortStops[n]["stop"]['geometry']['coordinates'][1],sortStops[n]["stop"]['geometry']['coordinates'][0]];
            coordinates2 = [sortStops[n+1]["stop"]['geometry']['coordinates'][1],sortStops[n+1]["stop"]['geometry']['coordinates'][0]];
            var marker = new L.Marker(coordinates, {icon: nearbyIcon}).bindPopup(sortStops[n]["stop"]['stop_name']);

            //var line = new L.polyline([coordinates, coordinates2]);
            stopOnRoute.addLayer(marker);
            //stopOnRoute.addLayer(line);

            n++;
          }
          x += `<option data-value="${sortStops[sortStops.length-1]["stop"]["id"]}" value="${sortStops[sortStops.length-1]["stop"]["stop_name"]}">`;
          
          coordinates = [sortStops[sortStops.length-1]["stop"]['geometry']['coordinates'][1],sortStops[sortStops.length-1]["stop"]['geometry']['coordinates'][0]];
          var marker = new L.Marker(coordinates, {icon: nearbyIcon}).bindPopup(sortStops[sortStops.length-1]["stop"]['stop_name']);
          stopOnRoute.addLayer(marker);
          map.fitBounds(stopOnRoute.getBounds());

          x += `</datalist><br>`;

          document.getElementById('list_StopsInRoute').innerHTML = x;

        }
        else {
          alert("Something went wrong!");
        }
      }
      // At last send the request
      xhr.send();

    }

    // show button
    // show on map start\end stops
    // short the list
    function showButtonForCalc() {
      document.getElementById('button_startCalc').innerHTML = `Date:<input id="date" type="date" name="task_date" />
      Time:<input id="time" type="time" name="task_time" /><br><br><button onclick="calculatePerFullRoute()">Start Calculate</button>`;

      // remove old route
      //map.removeLayer(On_OffRoute);
      On_OffRoute = L.featureGroup({}).addTo(map);

      // show on map the start and end stops
      coordinates = [sortStops[0]["stop"]['geometry']['coordinates'][1],sortStops[0]["stop"]['geometry']['coordinates'][0]];          
      var getOn = new L.Marker(coordinates, {icon: busGetOn}).bindPopup(sortStops[0]["stop"]['stop_name']);
      On_OffRoute.addLayer(getOn);

      var element_input = document.getElementById('eStop');
      var element_datalist = document.getElementById('eStop1');
      var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
      lastStopID = opSelected.getAttribute('data-value');

      var previusCoordinates = null;
      
      


      for (stopindex in stopsData) {
        stopsData_temp.push(stopsData[stopindex]);
        if ('stop' in stopsData[stopindex]) {
          if (stopsData[stopindex]['stop']['id'] == lastStopID) {
            endStopLocation = stopsData[stopindex]["stop"]["geometry"]["coordinates"];

            coordinates = [endStopLocation[1],endStopLocation[0]];
            var getOff = new L.Marker(coordinates, {icon: busGetOff}).bindPopup(stopsData[stopindex]["stop"]['stop_name']);
            On_OffRoute.addLayer(getOff);
            break; // stop pushing when end-stop founded
          }
        }
        else{
          coordinates = [stopsData[stopindex][1],stopsData[stopindex][0]];
          if (previusCoordinates!=null&&stopindex<stopsData.length-1){
            var line = new L.polyline([previusCoordinates, coordinates]);
            On_OffRoute.addLayer(line);
          }
          previusCoordinates = coordinates;
          
        }
      }
      //console.log('Sum mini location (geometry): ' + stopsData_temp.length);


      
      map.fitBounds(On_OffRoute.getBounds());
      // remove all stop
      map.removeLayer(stopOnRoute);
    }

    function findNearStops() {
      //show section
      document.getElementById('section2').style.display='block';

      // reset old
      map.removeLayer(nearbyStopMarker);
      map.removeLayer(On_OffRoute);
      map.removeLayer(stopOnRoute);
      nearbyStopMarker = L.featureGroup({}).addTo(map);
      On_OffRoute = L.featureGroup({}).addTo(map);
      stopOnRoute = L.featureGroup({}).addTo(map);

      var lat = document.getElementById('lat').value;
      var lon = document.getElementById('lon').value;
      var radius = document.getElementById('radius').value * 10;
      var url = 'https://transit.land/api/v2/rest/stops?apikey=iMDAuMorfb5YN90M8fmjiswA5okKN0zX&feed_onestop_id=f-sv-גלים~מועצהאזוריתגולן~אפיקים~דןצפון~דןבדרום~דןבארשבע~ירושלים&lat=' + lat + '&lon=' + lon + '&radius=' + radius + '&format=geojson';

      // Instantiate an new XHR Object
      const xhr = new XMLHttpRequest();

      // Open an obejct (GET/POST, PATH,
      // ASYN-TRUE/FALSE)
      xhr.open("GET", url, true);

      // When response is ready
      xhr.onload = function () {
        if (this.status === 200) {

          // Changing string data into JSON Object
          obj = JSON.parse(this.responseText);

          // Getting the ul element
          let list = document.getElementById("list");
          str = `<label for="stops">Choose a Stop:<input list="stops1" id="stops" onfocus="this.value=''" onChange="makeRoutesList()"></label>
                          <datalist name="stops" id="stops1">
                            <option value="" selected disabled hidden>Choose Start Stop</option>`;

          var n = 0;
          var stop_code = [];
        
          var nearbyIcon = L.icon({
            iconUrl: 'icons8-bus-48.png',
            iconSize:     [20, 20], // size of the icon
          });

           
          console.log('stops near by: ' + obj['features'].length);
          while (n < obj['features'].length) {
            data = obj['features'][n]['properties'];


            // when the stop already in the list (רציפים)
            if (stop_code.includes(data["stop_code"])) {
              //console.log("exist - " + data["stop_code"]);
            }
            else {
              str += `<option data-value="${data['stop_code']}" value="${data['stop_name']}">`;//${data['stop_code']}
              rootAllFirstStopsID[data['stop_code']] = data['id'];
              stop_code.push(data["stop_code"]);
              //console.log(data["stop_code"]);

              coordinates = [data['geometry']['coordinates'][1],data['geometry']['coordinates'][0]];

              var marker = new L.Marker(coordinates, {icon: nearbyIcon}).bindPopup(data['stop_name']);
            //var line = new L.polyline([markers[i],markers[i+1]]);
            nearbyStopMarker.addLayer(marker);
            //route.addLayer(line);

              //nearbyStopMarker.push(L.marker(coordinates).bindPopup('This is Littleton, CO.'));
            }

            if (dataFile[data['stop_code']] == null) {
              dataFile[data['stop_code']] = [];
            }
            dataFile[data['stop_code']] = [...dataFile[data['stop_code']], ...routes(data)]; //n+1 is the kay, value is the return array

            n++;
          } 

          str += `</datalist><br>`;
          //str += `<label id="val_num"></label>`;

          //var overlay = {'markers': nearbyStopMarker};
          //L.layerGroup(nearbyStopMarker);
          //L.control.layers(null,overlay).addTo(map);

          //nearbyStopMarker.addLayer(new L.Marker(markers[n-1]));

          map.fitBounds(nearbyStopMarker.getBounds());



          if (n != 0) {
            document.getElementById('collapse_head').innerHTML = 'Stations Nearby:';
            list.innerHTML = str;
          }
          else {
            alert("No stations found!\nTry to increase radius.")
          }

        }
        else {
          alert("Something went wrong!");
        }
      }

      // At last send the request
      xhr.send();


      var section2 = document.getElementById("section2");

      section2.scrollIntoView({
        behavior: "smooth",
        block: "start",
        inline: "nearest"
      });
    };

  </script>



  <!--
  not in use (stock tamplate)
  ################################################################################################################
  ################################################################################################################
  ################################################################################################################
  ################################################################################################################
 close button 
-->
  <!--div>


    <div class="w3-container">
      <hr>
      <div class="w3-center">
        <h2>Color Classes</h2>
      </div>

      <div class="w3-row">
        <div class="w3-col w3-container m2 w3-red">
          <p>Red</p>
        </div>
        <div class="w3-col w3-container m2 w3-blue">
          <p>Blue</p>
        </div>
        <div class="w3-col w3-container m2 w3-blue-grey">
          <p>Blue Grey</p>
        </div>
        <div class="w3-col w3-container m2 w3-teal">
          <p>Teal</p>
        </div>
        <div class="w3-col w3-container m2 w3-yellow">
          <p>Yellow</p>
        </div>
        <div class="w3-col w3-container m2 w3-orange">
          <p>Orange</p>
        </div>
      </div>

      <hr>
      <div class="w3-center">
        <h2>Built-In Responsiveness</h2>
        <p class="w3-large">Resize the page to see the effect!</p>
      </div>
      <br>

      <div class="w3-row w3-border">
        <div class="w3-half w3-container w3-blue w3-border">
          <h5>w3-half</h5>
          <p>The w3-half class uses half (50%) of the screen window.</p>
          <p>On small screens (max 600 pixels) it automatically resizes to full screen width.</p>
        </div>
        <div class="w3-half w3-container">
          <h5>w3-half</h5>
        </div>
      </div>
      <br>

      <div class="w3-row w3-border">
        <div class="w3-third w3-container w3-green">
          <h5>w3-third</h5>
          <p>The w3-third class uses one third (33.33%) of the screen widow.</p>
          <p>On small screens (max 600 pixels) it automatically resizes to full screen width.</p>
        </div>
        <div class="w3-third w3-container">
          <h5>w3-third</h5>
        </div>
        <div class="w3-third w3-container">
          <h5>w3-third</h5>
        </div>
      </div>
      <br>

      <div class="w3-row w3-border">
        <div class="w3-quarter w3-container w3-red">
          <h5>w3-quarter</h5>
          <p>The w3-quarter class uses one quarter (25%) of the screen window.</p>
          <p>On small screens (max 600 pixels) it automatically resizes to full screen width.</p>
        </div>
        <div class="w3-quarter w3-container">
          <h5>w3-quarter</h5>
        </div>
        <div class="w3-quarter w3-container">
          <h5>w3-quarter</h5>
        </div>
        <div class="w3-quarter w3-container">
          <h5>w3-quarter</h5>
        </div>
      </div>

      <div class="w3-center">
        <h2>Containers</h2>
        <p>Use containers to create headers, sections and footers.</p>
      </div>

      <header class="w3-container w3-blue-grey">
        <h2>Header</h2>
      </header>

      <div class="w3-padding w3-white w3-display-container">
        <span onclick="this.parentElement.style.display='none'" class="w3-button w3-display-topright"><i
            class="fa fa-remove"></i></span>
        <h2>London</h2>
        <p>London is the capital city of England. It is the most populous city in the United Kingdom,
          with a metropolitan area of over 13 million inhabitants.</p>
        <p>Standing on the River Thames, London has been a major settlement for two millennia,
          its history going back to its founding by the Romans, who named it Londinium.</p>
        <p>By the way, you can add a close icon to all containers if you want the ability to hide them. Look to your
          right!</p>
      </div>

      <footer class="w3-container w3-blue-grey">
        <h5>Footer</h5>
        <p class="w3-opacity">Footer information goes here</p>
      </footer>

      <hr>
      <div class="w3-center">
        <h2>Color Themes</h2>
        <p>The color themes have been designed to work harmoniously with each other.</p>
      </div>
    </div>

    <div class="w3-row-padding">

      <div class="w3-half">
        <div class="w3-card white">
          <div class="w3-container w3-indigo">
            <h3>Theme Indigo</h3>
          </div>
          <div class="w3-container">
            <h3 class="w3-text-indigo">Movies 2014</h3>
          </div>
          <ul class="w3-ul w3-border-top">
            <li>
              <h3>Frozen</h3>
              <p>The response to the animations was ridiculous</p>
            </li>
            <li>
              <h3>The Fault in Our Stars</h3>
              <p>Touching, gripping and genuinely well made</p>
            </li>
            <li>
              <h3>The Avengers</h3>
              <p>A huge success for Marvel and Disney</p>
            </li>
          </ul>
          <div class="w3-container w3-indigo w3-large"><span class="w3-right">Next</span></div>
        </div>
      </div>

      <div class="w3-half">
        <div class="w3-card white">
          <div class="w3-container w3-theme">
            <h3>Theme</h3>
          </div>
          <div class="w3-container">
            <h3 class="w3-text-theme">Movies 2014</h3>
          </div>
          <ul class="w3-ul w3-border-top">
            <li>
              <h3>Frozen</h3>
              <p>The response to the animations was ridiculous</p>
            </li>
            <li>
              <h3>The Fault in Our Stars</h3>
              <p>Touching, gripping and genuinely well made</p>
            </li>
            <li>
              <h3>The Avengers</h3>
              <p>A huge success for Marvel and Disney</p>
            </li>
          </ul>
          <div class="w3-container w3-theme w3-large"><span class="w3-right">Next</span></div>
        </div>
      </div>
    </div>

    <div class="w3-container w3-center">
      <hr>
      <h3>Paper-like Cards with Shadows</h3>
    </div>

    <div class="w3-row-padding">

      <div class="w3-third">
        <div class="w3-card">
          
          <div class="w3-container">
            <p>w3-card</p>
          </div>
        </div>
      </div>

      <div class="w3-third">
        <div class="w3-card-4">
          
            <p>w3-card-4</p>
          </div>
        </div>
      </div>

      <div class="w3-third">
        <div class="w3-card-4">
          
          <div class="w3-container">
            <p>w3-card-4</p>
          </div>
        </div>
      </div>
    </div>

    <div class="w3-container">
      <hr>
      <div class="w3-center">
        <h2>Tables</h2>
        <p w3-class="w3-large">Don't worry. W3.CSS takes care of your tables.</p>
      </div>
      <div class="w3-responsive w3-card-4">
        <table class="w3-table w3-striped w3-bordered">
          <thead>
            <tr class="w3-theme">
              <th>First Name</th>
              <th>Last Name</th>
              <th>Points</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Jill</td>
              <td>Smith</td>
              <td>50</td>
            </tr>
            <tr class="w3-white">
              <td>Eve</td>
              <td>Jackson</td>
              <td>94</td>
            </tr>
            <tr>
              <td>Adam</td>
              <td>Johnson</td>
              <td>67</td>
            </tr>
          </tbody>
        </table>
      </div>

      <hr>
      <h2 class="w3-center">Forms and Lists</h2>
    </div>

    <div class="w3-row-padding">

      <div class="w3-half">
        <form class="w3-container w3-card-4">
          <h2>Input Form</h2>
          <div class="w3-section">
            <input class="w3-input" type="text" required>
            <label>Name</label>
          </div>
          <div class="w3-section">
            <input class="w3-input" type="text" required>
            <label>Email</label>
          </div>
          <div class="w3-section">
            <input class="w3-input" type="text" required>
            <label>Subject</label>
          </div>

          <div class="w3-row">
            <div class="w3-half">
              <input id="milk" class="w3-check" type="checkbox" checked="checked">
              <label>Milk</label>
              <br>
              <input id="sugar" class="w3-check" type="checkbox">
              <label>Sugar</label>
              <br>
              <input id="lemon" class="w3-check" type="checkbox" disabled>
              <label>Lemon (Disabled)</label>
              <br><br>
            </div>

            <div class="w3-half">
              <input id="male" class="w3-radio" type="radio" name="gender" value="male" checked>
              <label>Male</label>
              <br>
              <input id="female" class="w3-radio" type="radio" name="gender" value="female">
              <label>Female</label>
              <br>
              <input id="unknown" class="w3-radio" type="radio" name="gender" value="" disabled>
              <label> Don't know (Disabled)</label>
            </div>
          </div>
        </form>
      </div>
      <div class="w3-half">
        <div class="w3-card-4 w3-container">
          <h2>Lists</h2>
          <ul class="w3-ul w3-margin-bottom">
            <li>Jill</li>
            <li>Eve</li>
            <li>Adam</li>
          </ul>
          <br>
          <select class="w3-ul w3-border w3-hoverable">
            <option class="w3-theme">Jill</option>
            <option>Eve</option>
            <li>Adam</li>
            <li>Steve</li>
          </select>
          <br>
        </div>
      </div>
    </div>
    <hr>

    <h2 class="w3-center">Progress Bars</h2>
    <div class="w3-container">

      <div class="w3-light-gray">
        <div id="myBar" class="w3-center w3-padding w3-theme" style="width:5%">5%</div>
      </div><br>
      <button class="w3-btn w3-theme" onclick="move()">Click Me</button>
    </div>
    <hr>

    <h2 class="w3-center">Slideshows</h2>
    <div class="w3-content" style="max-width:800px;position:relative">

  

      <a class="w3-button w3-hover-dark-grey" style="position:absolute;top:45%;left:0;" onclick="plusDivs(-1)">❮</a>
      <a class="w3-button w3-hover-dark-grey" style="position:absolute;top:45%;right:0;" onclick="plusDivs(+1)">❯</a>
    </div>

    <div class="w3-container">
      <hr>
      <h2 class="w3-center">Navigation</h2>

      <div class="w3-bar w3-theme">
        <a href="#" class="w3-bar-item w3-button w3-padding-16">Home</a>
        <a href="#" class="w3-bar-item w3-button w3-padding-16">Link 1</a>
        <div class="w3-dropdown-hover">
          <button class="w3-button w3-padding-16">
            Dropdown <i class="fa fa-caret-down"></i>
          </button>
          <div class="w3-dropdown-content w3-card-4 w3-bar-block">
            <a href="javascript:void(0)" class="w3-bar-item w3-button">Link 1</a>
            <a href="javascript:void(0)" class="w3-bar-item w3-button">Link 2</a>
            <a href="javascript:void(0)" class="w3-bar-item w3-button">Link 3</a>
          </div>
        </div>
      </div>

      <hr>
      <h2 class="w3-center">Accordions</h2>
      <button onclick="myAccFunc('Demo1')" class="w3-padding-16 w3-theme w3-button w3-block w3-left-align">Open Section
        1</button>
      <div id="Demo1" class="w3-hide">
        <div class="w3-container">
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et
            dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex
            ea commodo consequat.</p>
        </div>
      </div>
      <button onclick="myAccFunc('Demo2')" class="w3-padding-16 w3-theme w3-button w3-block w3-left-align">Open Section
        2</button>
      <div id="Demo2" class="w3-hide">
        <a href="#" class="w3-button w3-block w3-left-align">Link 1</a>
        <a href="#" class="w3-button w3-block w3-left-align">Link 2</a>
        <a href="#" class="w3-button w3-block w3-left-align">Link 3</a>
      </div>
      <button onclick="myAccFunc('Demo3')" class="w3-padding-16 w3-theme w3-button w3-block w3-left-align">Open Section
        3</button>
      <div id="Demo3" class="w3-hide w3-black">
        <div class="w3-container">
          <p>Accordion with Images:</p>
          
          <p>French Alps</p>
        </div>
      </div>

      <hr>
      <h2 class="w3-center">Tabs</h2>
      <div class="w3-border">
        <div class="w3-bar w3-theme">
          <button class="w3-bar-item w3-button testbtn w3-padding-16" onclick="openCity(event,'London')">London</button>
          <button class="w3-bar-item w3-button testbtn w3-padding-16" onclick="openCity(event,'Paris')">Paris</button>
          <button class="w3-bar-item w3-button testbtn w3-padding-16" onclick="openCity(event,'Tokyo')">Tokyo</button>
        </div>

        <div id="London" class="w3-container city w3-animate-opacity">
          <h2>London</h2>
          <p>London is the capital city of England.</p>
          <p>It is the most populous city in the United Kingdom, with a metropolitan area of over 13 million
            inhabitants.</p>
        </div>

        <div id="Paris" class="w3-container city w3-animate-opacity">
          <h2>Paris</h2>
          <p>Paris is the capital of France.</p>
          <p>The Paris area is one of the largest population centers in Europe, with more than 12 million inhabitants.
          </p>
        </div>

        <div id="Tokyo" class="w3-container city w3-animate-opacity">
          <h2>Tokyo</h2>
          <p>Tokyo is the capital of Japan.</p>
          <p>It is the center of the Greater Tokyo Area, and the most populous metropolitan area in the world.</p>
        </div>
      </div>

      <hr>
      <h2 class="w3-center">Buttons</h2>
      <div class="w3-center">
        <br>
        <a class="w3-button w3-theme">Button</a>
        <a class="w3-button w3-theme">Button</a>
        <a class="w3-button w3-theme-d3 w3-disabled">Button</a>
        <br><br>
        <a class="w3-button w3-circle w3-large w3-black"><i class="fa fa-plus"></i></a>
        <a class="w3-button w3-circle w3-large w3-theme"><i class="fa fa-plus"></i></a>
        <a class="w3-button w3-circle w3-large w3-card-4"><i class="fa fa-plus"></i></a>
      </div>
      <br>
      <div class="w3-center">
        <div class="w3-dropdown-hover">
          <button class="w3-button w3-theme">Dropdown <i class="fa fa-caret-down"></i></button>
          <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="#" class="w3-bar-item w3-button">Link 1</a>
            <a href="#" class="w3-bar-item w3-button">Link 2</a>
            <a href="#" class="w3-bar-item w3-button">Link 3</a>
          </div>
        </div>
      </div>

    </div>

    <hr>
    <div class="w3-center">
      <h2>Pagination</h2>
     
      <div class="w3-center w3-padding-32">
        <div class="w3-bar">
          <a href="#" class="w3-bar-item w3-button w3-hover-theme">«</a>
          <a href="#" class="w3-bar-item w3-button w3-theme w3-hover-theme">1</a>
          <a href="#" class="w3-bar-item w3-button w3-hover-theme">2</a>
          <a href="#" class="w3-bar-item w3-button w3-hover-theme">3</a>
          <a href="#" class="w3-bar-item w3-button w3-hover-theme">4</a>
          <a href="#" class="w3-bar-item w3-button w3-hover-theme">5</a>
          <a href="#" class="w3-bar-item w3-button w3-hover-theme">»</a>
        </div>
      </div>
    </div>
    <br-->

    
    <footer class="w3-container w3-padding-16">
      <select id="lang" onchange="loadTranslate()">
        <option value="en">English</option>
        <option value="iw">Hebrew</option>
        </option>
      </select>
      <!--h3>Footer</h3>
      <p>Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank">w3.css</a></p>
      <div style="position:relative;bottom:55px;" class="w3-tooltip w3-right">
        <span class="w3-text w3-theme-light w3-padding">Go To Top</span> 
        <a class="w3-text-white" href="#myHeader"><span class="w3-xlarge">
            <i class="fa fa-chevron-circle-up"></i></span></a>
      </div-->
      <p data-lang="test">Remember to check out our  <a href="w3css_references.asp" class="w3-btn w3-theme-light" target="_blank">W3.CSS
          Reference</a></p>

    </footer>
  </div>

  <script src="languages.js"></script>
  <!-- Script for Sidebar, Tabs, Accordions, Progress bars and slideshows -->
  <script>
    
    function loadTranslate(){
      var LngObject = JSON.parse(data); // from "languages.js"
      var translate = new Translate();
      var currentLng = document.getElementById('lang').value;//'fr'\'en'
      var attributeName = 'data-lang';
      translate.init(attributeName, currentLng, LngObject);
      translate.process(); 
    }

    // Source: http://stackoverflow.com/questions/497790
    var dates = {
    convert:function(d) {
        // Converts the date in d to a date-object. The input can be:
        //   a date object: returned without modification
        //  an array      : Interpreted as [year,month,day]. NOTE: month is 0-11.
        //   a number     : Interpreted as number of milliseconds
        //                  since 1 Jan 1970 (a timestamp) 
        //   a string     : Any format supported by the javascript engine, like
        //                  "YYYY/MM/DD", "MM/DD/YYYY", "Jan 31 2009" etc.
        //  an object     : Interpreted as an object with year, month and date
        //                  attributes.  **NOTE** month is 0-11.
        return (
            d.constructor === Date ? d :
            d.constructor === Array ? new Date(d[0],d[1],d[2]) :
            d.constructor === Number ? new Date(d) :
            d.constructor === String ? new Date(d) :
            typeof d === "object" ? new Date(d.year,d.month,d.date) :
            NaN
        );
    },
    compare:function(a,b) {
        // Compare two dates (could be of any type supported by the convert
        // function above) and returns:
        //  -1 : if a < b
        //   0 : if a = b
        //   1 : if a > b
        // NaN : if a or b is an illegal date
        // NOTE: The code inside isFinite does an assignment (=).
        return (
            isFinite(a=this.convert(a).valueOf()) &&
            isFinite(b=this.convert(b).valueOf()) ?
            (a>b)-(a<b) :
            NaN
        );
    },
    inRange:function(d,start,end) {
        // Checks if date in d is between dates in start and end.
        // Returns a boolean or NaN:
        //    true  : if d is between start and end (inclusive)
        //    false : if d is before start or after end
        //    NaN   : if one or more of the dates is illegal.
        // NOTE: The code inside isFinite does an assignment (=).
       return (
            isFinite(d=this.convert(d).valueOf()) &&
            isFinite(start=this.convert(start).valueOf()) &&
            isFinite(end=this.convert(end).valueOf()) ?
            start <= d && d <= end :
            NaN
        );
    }
}

function isDayNow(StopLocation) {

  var date = document.getElementById("date").value,
      time = document.getElementById("time").value;
  var dateNow = new Date();

  // in case user didnt give info, use current time.
  if (date == "") {
    date = dateNow.toDateString();
  }
  if (time == "") {
    time = dateNow.toLocaleTimeString(); // option to add 'en-US'
  }

  customDate = new Date(date + " " + time);
  //console.log(customDate)

  sunCalcTime = SunCalc.getTimes(/*Date*/ customDate,
                                  /*Number*/ StopLocation[0],
                                  /*Number*/ StopLocation[1], 
                                  /*Number (default=0)*/ 0);

  startTime = sunCalcTime['sunriseEnd']
  endTime = sunCalcTime['sunsetStart']
  return dates.inRange(customDate,startTime,endTime);
}

    /* Side navigation
    function w3_open() {
      var x = document.getElementById("mySidebar");
      x.style.width = "100%";
      x.style.fontSize = "40px";
      x.style.paddingTop = "10%";
      x.style.display = "block";
    }
    function w3_close() {
      document.getElementById("mySidebar").style.display = "none";
    }
    

    // Tabs
    function openCity(evt, cityName) {
      var i;
      var x = document.getElementsByClassName("city");
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
      var activebtn = document.getElementsByClassName("testbtn");
      for (i = 0; i < x.length; i++) {
        activebtn[i].className = activebtn[i].className.replace(" w3-dark-grey", "");
      }
      document.getElementById(cityName).style.display = "block";
      evt.currentTarget.className += " w3-dark-grey";
    }

    var mybtn = document.getElementsByClassName("testbtn")[0];
    mybtn.click();

    // Accordions
    function myAccFunc(id) {
      var x = document.getElementById(id);
      if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
      } else {
        x.className = x.className.replace(" w3-show", "");
      }
    }

    // Slideshows
    var slideIndex = 1;

    function plusDivs(n) {
      slideIndex = slideIndex + n;
      showDivs(slideIndex);
    }

    function showDivs(n) {
      var x = document.getElementsByClassName("mySlides");
      if (n > x.length) { slideIndex = 1 }
      if (n < 1) { slideIndex = x.length };
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
      x[slideIndex - 1].style.display = "block";
    }

    showDivs(1);

    // Progress Bars
    function move() {
      var elem = document.getElementById("myBar");
      var width = 5;
      var id = setInterval(frame, 10);
      function frame() {
        if (width == 100) {
          clearInterval(id);
        } else {
          width++;
          elem.style.width = width + '%';
          elem.innerHTML = width * 1 + '%';
        }
      }
    }
    */
  </script>

</body>

</html>