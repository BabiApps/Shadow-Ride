<!DOCTYPE html>
<html lang="iw">

<head>
  <title>Shadow Ride</title>
  <meta name="description" content="Do you travel a lot on the bus? 
    Ride with us, and we tell you where to sit on the bus, 
    so your ride will be sunless">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/png" href="images/logo.png">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" type="text/css" href="css/main.css">
</head>



<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">

<!-- old color 
  background-color: #336B90;
-->
<style>
  .backgroud {
    background-color: #468aa6;
  }

  @media (max-width: 480px) {
    img {
      max-width: 100%;
      width: auto;
      height: auto;
    }
  }

  @media (min-width: 481px) {
    img {
      max-width: 38%;
      width: auto;
      height: auto;
    }
  }

  @media (max-width: 480px) {
    .pedding_section {
      padding-top: 10px;
      padding-bottom: 10px;

    }
  }

  @media (min-width: 481px) {
    .pedding_section {
      padding-left: 0;
      padding-right: 0;
    }
  }

  .modal-header {
    padding: 2px 16px;
    background-color: #5cb85c;
    color: white;
  }

  /* Modal Body */
  .modal-body1 {
    padding: 2px 16px;
  }
  .modal-body2 {
    padding: 2px 16px;
  }

  /* Modal Footer */
  .modal-footer {
    padding: 2px 16px;
    background-color: #5cb85c;
    color: white;
  }

  /* Modal Content */
  .modal-content {
    position: relative;
    background-color: #fefefe;
    margin: auto;
    padding: 0;
    border: 1px solid #888;
    width: 80%;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
    animation-name: animatetop;
    animation-duration: 0.4s
  }

  /* Add Animation */
  @keyframes animatetop {
    from {
      top: -300px;
      opacity: 0
    }

    to {
      top: 0;
      opacity: 1
    }
  }

  .modal {
    display: none;
    /* Hidden by default */
    position: fixed;
    /* Stay in place */
    z-index: 1;
    /* Sit on top */
    left: 0;
    top: 0;
    width: 100%;
    /* Full width */
    height: 100%;
    /* Full height */
    overflow: hidden;
    /* Enable scroll if needed */
    background-color: rgb(0, 0, 0);
    /* Fallback color */
    background-color: rgba(0, 0, 0, 0.4);
    /* Black w/ opacity */
  }

  /* Modal Content/Box */
  .modal-content {
    background-color: #fefefe;
    margin: 25% auto;
    /* 45% from the top and centered */
    padding: 15px;
    border: 1px solid #888;
    width: 80%;
    /* Could be more or less, depending on screen size */
  }

  /* The Close Button */
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
</style>

<body class="fullscreen">
  <span id="connection"><abbr title="You are online!">&#128246;</abbr></span>
  <div id="showInstall">
    <!--img id="installApp" src="images/download.png"-->
  </div>



  <!-- Header -->
  <header class="w3-container backgroud w3-padding" id="myHeader">

    <div class="w3-center">
      <img src="ShadowRide_logo_3-11.png" alt="shadowRidePic">
    </div>


    <script src="https://cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js"></script>
    <link rel="stylesheet" href="center-radar.css">
    <!--#######################################################################################################################
      ########################################################################################################################
      ########################################################################################################################
      todo - move to local method (ring loading)link rel="stylesheet" href="css/loading.css"-->
    <!--div class="ring">Loading<span></span>
  </div-->


    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6474275493517014"
      crossorigin="anonymous"></script>
    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script-->
  </header>

  <!-- The Modal -->
  <div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
      <span onclick="document.getElementById('myModal').style.display='none'" class="close">&times;</span>
      <p id="modal-body1">Some text in the Modal..</p>
      <p id="modal-body2">Some text in the Modal..</p>
      <p id="modal-body3">נסיעה נעימה!</p>
    </div>
  </div>



  <div class="w3-row-padding w3-margin-top">
    <div class="w3-third">
      <div class="w3-card w3-container" style=" padding-bottom: 10px;">
        <!--h3>min-height:400px;ריבוע שמאלי</h3-->

        <br>
        <details>
          <summary>הכנס מיקום ידנית</summary>
          <div style="margin-top: 5px;" class="w3-section">
            <input class="input-value-manually" type="number" step="0.00000001" id="lat" required>
            <label>קו רוחב</label>
          </div>
          <div class="w3-section">
            <input class="input-value-manually" type="number" step="0.00000001" id="lon" required>
            <label>קו אורך</label>
          </div>
          <div class="w3-section">
            <input class="input-value-manually" type="number" id="radius" value="20" required>
            <label>מרחק (M)</label>
          </div>
        </details>

        <button style="margin-right: 5px;margin-top: 10px" class="w3-btn w3-dark-grey w3-hover-light-grey"
          onclick="getLocation()">מצא את המיקום שלי</button>
        <button style="margin-top: 10px" class="w3-btn w3-blue w3-hover-light-grey" onclick="findNearStops()">מצא תחנות
          קרובות באיזור</button>

      </div>
    </div>


    <!-- ##################################################################
  MAP
####################################################################### -->
    <div class="w3-third w3-center pedding_section" style="right: 0; ">
      <!--#################################################### 
        for right set: "position: absolute;"
      but it over the input section -->
      <div class="w3-card w3-container" id="mapInRight" style="min-height:400px; z-index: 1;">
      </div>
    </div>
    <!-- not in use script src="OpenLayers.js"></script-->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" />
    <!-- script for showing the map -->
    <script type="text/javascript">
      // Where you want to render the map.
      var element = document.getElementById('mapInRight');
      var pickMarker = null;

      // Height has to be set. You can do this in CSS too.
      //element.style = 'z-index: 1;';

      // Create Leaflet map on map element.
      var map = L.map(element);

      // Add OSM tile layer to the Leaflet map.
      L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Target's GPS coordinates.


      var target = L.latLng('32.83325770280918', '35.79960352932844');
      document.getElementById('lat').value = target['lat'];
      document.getElementById('lon').value = target['lng'];

      // Set map's center to target with zoom 14.
      map.setView(target, 14);

      map.on('click', addMarker);

      function addMarker(e) {
        // Add marker to map at click location; 
        if (pickMarker != null) {
          //map.removeLayer(oldMarker);
          pickMarker.setLatLng(e.latlng).update();  // Updates your defined marker position
        } else {
          pickMarker = new L.marker(e.latlng);
          pickMarker.addTo(map);
        }

        document.getElementById('lat').value = e.latlng['lat'];
        document.getElementById('lon').value = e.latlng['lng'];
      }

  // Place a marker on the same location.
  //L.marker(target).addTo(map);
    </script>


    <script>// Get the modal
      var modal = document.getElementById("myModal");

      // Get the button that opens the modal
      /*var btn = document.getElementById("myBtn");
      // When the user clicks on the button, open the modal
      btn.onclick = function() {
        modal.style.display = "block";
        modal.style.zIndex = "2"
      }*/

      // Get the <span> element that closes the modal
      var span = document.getElementsByClassName("close")[0];

      // When the user clicks on <span> (x), close the modal
      span.onclick = function () {
        modal.style.display = "none";
        modal.style.zIndex = ""
      }

      // When the user clicks anywhere outside of the modal, close it
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }</script>
    <!-- middle -->
    <div class="w3-third pedding_section" id="section2" style="display: none;">
      <div class="w3-card w3-container " style="min-height:400px">
        <h3 class="w3-center" id=collapse_head></h3><br>
        <div id='list'></div>
        <div id='listForTest'></div>
        <div id='list_StopsInRoute'></div>
        <div class="w3-center" id='button_startCalc'></div>
        <div id='showAnswer'></div>

      </div>
    </div>
  </div>


  <!-- ads banner in shadow ride -->
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6474275493517014" data-ad-slot="4521837045"
    data-ad-format="auto" data-full-width-responsive="true">
  </ins>

  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>

  <script src="./fun.js"></script>
  <script src="./suncalc.js"></script>
  <script src="js/jquery.min.js"></script>
  <script src="js/main.js"></script>

  <script>
    //globle varible
    var dataFile = [];
    var stopsData = [];
    var stopsData_temp = [];
    var rootAllFirstStopsID = [];
    var rootAllNearbyStopsLocation = []; //###################################### TODO: need to be reset 
    var sortStops = []; // without geomrtry on road/line
    var getOn;

    var nearbyStopMarker = L.featureGroup().addTo(map);
    var On_OffRoute = L.featureGroup().addTo(map);
    var stopOnRoute = L.featureGroup().addTo(map);
    // https://stackoverflow.com/a/39968118

    var busGetOn = L.icon({
      iconUrl: 'icons8-get-on-bus-100.png',
      iconSize: [25, 25], // size of the icon
    });
    var busGetOff = L.icon({
      iconUrl: 'icons8-get-off-bus-100.png',
      iconSize: [25, 25], // size of the icon
    });

    $('.hidekeyboard').on('focus',function(){
    $(this).trigger('blur');
    });

    // find device location
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    function showPosition(position) {
      document.getElementById('lat').value = position.coords.latitude;
      document.getElementById('lon').value = position.coords.longitude;
      target = L.latLng(position.coords.latitude, position.coords.longitude);

      if (pickMarker != null) {
        //map.removeLayer(oldMarker);
        pickMarker.setLatLng(target).update();  // Updates your defined marker position
      } else {
        pickMarker = new L.marker(target);
        pickMarker.addTo(map);
      }
      map.setView(target, 14);
    }

    // ##################################################################################################################################
    // ##################################################################################################################################

    function calculatePerFullRoute() {

      var firstStopID, lastStopID;
      var textToShow = '';

      //find the first and last stop (to remove all stop out-line)
      {
        var element_input_fStop = document.getElementById('stops');
        var element_datalist = document.getElementById('stops1');
        var opSelected = element_datalist.querySelector(`[value="${element_input_fStop.value}"]`);
        tempValue1 = opSelected.getAttribute('data-value');
        firstStopID = rootAllFirstStopsID[tempValue1];

        var element_input_eStop = document.getElementById('eStop');
        var element_datalist = document.getElementById('eStop1');
        var opSelected = element_datalist.querySelector(`[value="${element_input_eStop.value}"]`);
        lastStopID = opSelected.getAttribute('data-value');

        //console.log('First stop ID - ' + firstStopID);
        //console.log('Last stop ID - ' + lastStopID);
      }

      var element_input = document.getElementById('routes');
      var element_datalist = document.getElementById('routes1');
      var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
      tripID = opSelected.getAttribute('data-value');

      var urlTrip = 'https://transit.land/api/v2/rest/routes/'
        + tripID //+'11823599' // ID
        + '/trips?apikey=iMDAuMorfb5YN90M8fmjiswA5okKN0zX&format=geojson'

      // Instantiate an new XHR Object
      const xhr = new XMLHttpRequest();

      // Open an obejct (GET/POST, PATH,
      // ASYN-TRUE/FALSE)
      xhr.open("GET", urlTrip, true);

      // When response is ready
      xhr.onload = function () {
        if (this.status === 200) {
          // Changing string data into JSON Object
          objTrip = JSON.parse(this.responseText);


          // flag in no error on objTrip
          objTrip_flag = true

          try {
            tripTime = objTrip['features'][0]['properties']['stop_times']
          }
          catch {
            alert("שגיאה!\nלא הצלחתי לגשת לזמני הנסיעה של האוטובוס\nולכן יהיה שימוש באותו הזמן לאורך כל הדרך (פחות מדוייק)");
            console.log('ERROR! Cant get the trip info\n'+ urlTrip)
            objTrip_flag = false
            tripTime = []
          }



          // Found the first stop time to compare to
          let firstStopTimeInTrip = new Date();
          for (numStops = 0; numStops < tripTime.length; numStops++) {
            if (stopsData_temp[0]['stop']['id'] == tripTime[numStops]['stop']['id']) {
              let [hours, minutes, seconds] = tripTime[numStops]['arrival_time'].split(':');
              firstStopTimeInTrip.setHours(+hours);
              firstStopTimeInTrip.setMinutes(minutes);
              firstStopTimeInTrip.setSeconds(seconds);
              break
            }
          }
          

          ///console.log(tripTime)
          //################################################################################
          //####################### move the function to here ##############################
          // * isDayNow when time updated
          // * comper to stop id (not name)


          var distanceR = 0, distanceL = 0, SumDistance_Air = 0, sumNull = 0;
          var cBus, diffC, persent, persentSide, sum_cBus = 0;

          // get the intial time for calculation
          var userDate = document.getElementById("date").value,
            userTime = document.getElementById("time").value;
          var dateNow = new Date();

          // in case user didnt give info, use system time.
          if (date == "") {
            userDate = dateNow.toLocaleDateString();
          }
          if (time == "") {
            userTime = dateNow.toLocaleTimeString();
          }
          var userFinalDate = new Date(userDate + " " + userTime);

          console.log('User Date: ' + userFinalDate)
          isDay = isDayNow(endStopLocation, userFinalDate);

          if (isDay) {
            for (var i = 0; i < stopsData_temp.length - 1 && isDay; i++) {

              //defult time (by user)
              var customStopTime = new Date(userFinalDate.getTime());
                
              // 1. Find start stop *location*
              // 2. when find a stop - update the tripTime 
              if ('stop' in stopsData_temp[i]) {
                startStop = stopsData_temp[i]["stop"]["geometry"]["coordinates"];

                
                
                //update the tripTime
                for (numStops = 0; numStops < tripTime.length; numStops++) {
                  if (stopsData_temp[i]['stop']['id'] == tripTime[numStops]['stop']['id']) {
                    customStopTime = new Date();
                    var [hours2, minutes2, seconds2] = tripTime[numStops]['arrival_time'].split(':');
                    customStopTime.setHours(+hours2)
                    customStopTime.setMinutes(minutes2)
                    customStopTime.setSeconds(seconds2);

                    customStopTime = new Date(userFinalDate.getTime() + (customStopTime - firstStopTimeInTrip));
                    console.log('-------\nThe bus will be in ' + stopsData_temp[i]['stop']['stop_name'] + '\nAt: ' + customStopTime)
                    break
                    //this method not include the last stop
                  }
                }

              }
              else {
                startStop = stopsData_temp[i];
              }
              // find end stop *location*
              if ('stop' in stopsData_temp[i + 1]) {
                endStop = stopsData_temp[i + 1]["stop"]["geometry"]["coordinates"];
              }
              else {
                endStop = stopsData_temp[i + 1];
              }

              distance_Air = distanceBetweenStops(startStop, endStop);
              SumDistance_Air += distance_Air;
              cBus = anglePer2stops(startStop, endStop);

              suncalcVar = SunCalc.getPosition(customStopTime, startStop[0], startStop[1]);
              cSun = suncalcVar['azimuth'] * 180 / Math.PI + 180;

              diffC = cSun - cBus;
              cBus_getSide = get_R_L_by_cBus(diffC);


              //#########################################################################################################################
              //#########################################################################################################################
              //#########################################################################################################################
              //#########################################################################################################################
              // todo : colored line on road, for visual 

              if (cBus_getSide == "Right") {
                distanceR += distance_Air;
              }
              else if (cBus_getSide == "Left") {
                distanceL += distance_Air;
              }
              else {
                sumNull++;
              }

              // check if in the middle the sun go down
              isDay = isDayNow(startStop, customStopTime)

              //###############################################################
              // todo - if is night in the middle trip - response
            }


            console.log('-------\nSum M in Right: ' + distanceR + '\nSum M in Left: ' + distanceL + '\nUndefined: ' + sumNull);


            if (distanceR > distanceL) {
              persent = distanceR / SumDistance_Air;
              persentSide = "ימין";
              persentSideNegativ = "שמאל";
            }
            else {
              persent = distanceL / SumDistance_Air;
              persentSide = "שמאל";
              persentSideNegativ = "ימין";
            }

            x = { 'persent': Math.round(persent * 100), 'persentSide': persentSide, 'persentSideNegativ': persentSideNegativ };

            if (i == 0) {
              textToShow1 = "אנא בחר תחנה יעד שהיא לא התחנת מוצא"
              document.getElementById('showAnswer').innerHTML = textToShow1;
              alert('אותו מיקום! אנא בחר תחנת ירידה אחרת')
            } else {
              //textToShow_old = `${x["persent"]}% From the Route,\nThe SUN is on your ${x["persentSide"]} side.\nYou should sit on the ${x["persentSideNegativ"]} side`;
              textToShow1 = `אוי לא! צד ${x["persentSide"]} מלא בשמש (כ${x["persent"]}% מהדרך).\n`
              textToShow2 = `ולכן אנחנו ממליצים לך לשבת בצד ${x["persentSideNegativ"]} של האוטובוס :)`
              document.getElementById('showAnswer').innerHTML = textToShow1 + textToShow2;
            }

          }
          //if is not day (or error in compare)
          else {
            textToShow1 = "חדשות טובות! אתה יכול לשבת איפה שרק תרצה באוטובוס :)"
            textToShow2 = ""
            document.getElementById('showAnswer').innerHTML = textToShow1;
          }
          document.getElementById('modal-body1').innerHTML = textToShow1
          document.getElementById('modal-body2').innerHTML = textToShow2
          // check when empty (user press reset button)
          //document.getElementById('modalHeader').innerHTML = `ב${document.getElementById('routes').value}, מהתחנה ${document.getElementById('stops').value} עד תחנה ${document.getElementById('eStop').value}`

          document.getElementById('myModal').style.display = "block";
          document.getElementById('myModal').style.zIndex = "2"


        }
        else {
          alert("TripURL fail");
          console.log("TripURL fail");
        }
      }
      // At last send the request
      xhr.send();


      //old method (no time diffrence)
      /*
      //console.log(firstStopID+'\n'+lastStopID)

      //console.log(stopsData_temp)
      var distanceR = 0, distanceL = 0, SumDistance_Air = 0, sumNull = 0;
      var cBus, diffC, persent, persentSide, sum_cBus = 0;

      // check the time for calcultion
      var userDate = document.getElementById("date").value,
              userTime = document.getElementById("time").value;
      var dateNow = new Date();

      // in case user didnt give info, use system time.
      if (date == "") {
        userDate = dateNow.toDateString();
      }
      if (time == "") {
        userTime = dateNow.toLocaleTimeString();
      }
      var userFinalDate = new Date(userDate + " " + userTime);
      
      isDay = isDayNow(endStopLocation, userFinalDate);

      if (isDay){
        for (var i = 0; i < stopsData_temp.length - 1; i++) {

          // find start stop location
          if ('stop' in stopsData_temp[i]) {
            startStop = stopsData_temp[i]["stop"]["geometry"]["coordinates"];
          }
          else {
            startStop = stopsData_temp[i];
          }
          // find end stop location
          if ('stop' in stopsData_temp[i + 1]) {
            endStop = stopsData_temp[i + 1]["stop"]["geometry"]["coordinates"];
          }
          else {
            endStop = stopsData_temp[i + 1];
          }

          distance_Air = distanceBetweenStops(startStop, endStop);
          SumDistance_Air += distance_Air;
          cBus = anglePer2stops(startStop, endStop);          

          suncalcVar = SunCalc.getPosition(userFinalDate, startStop[0], startStop[1]);
          cSun = suncalcVar['azimuth'] * 180 / Math.PI + 180;

          diffC = cSun - cBus;
          cBus_getSide = get_R_L_by_cBus(diffC);


          //#########################################################################################################################
          //#########################################################################################################################
          //#########################################################################################################################
          //#########################################################################################################################
          // todo : colored line on road, for visual 

          if (cBus_getSide == "Right") {
            distanceR += distance_Air;
          }
          else if (cBus_getSide == "Left") {
            distanceL += distance_Air;
          }
          else {
            sumNull++;
          }

          

        

        }
      
      
        console.log('-------\nSum M in Right: ' + distanceR + '\nSum M in Left: ' + distanceL + '\nUndefined: ' + sumNull);


        if (distanceR > distanceL) {
          persent = distanceR / SumDistance_Air;
          persentSide = "ימין";
          persentSideNegativ = "שמאל";
        }
        else {
          persent = distanceL / SumDistance_Air;
          persentSide = "שמאל";
          persentSideNegativ = "ימין";
        }

        x = { 'persent': Math.round(persent*100), 'persentSide': persentSide , 'persentSideNegativ': persentSideNegativ};

        if (i == 0) {
          textToShow = "אנא בחר תחנה יעד שהיא לא התחנת מוצא"
          document.getElementById('showAnswer').innerHTML = textToShow;
          alert('אותו מיקום! אנא בחר תחנת ירידה אחרת')
        } else {
          //textToShow_old = `${x["persent"]}% From the Route,\nThe SUN is on your ${x["persentSide"]} side.\nYou should sit on the ${x["persentSideNegativ"]} side`;
          textToShow = `אוי לא! צד ${x["persentSide"]} מלא בשמש (כ${x["persent"]}% מהדרך).\n
          ולכן אנחנו ממליצים לך לשבת בצד ${x["persentSideNegativ"]} של האוטובוס :)
           נסיעה נעימה`
          document.getElementById('showAnswer').innerHTML = textToShow;
        }
      }
      //if is not day (or error in compare)
      else{
        textToShow = "חדשות טובות! אתה יכול לשבת איפה שרק תרצה באוטובוס :)"
        document.getElementById('showAnswer').innerHTML = textToShow;
      }
      document.getElementById('modal-body').innerHTML = textToShow
      // check when empty (user press reset button)
      //document.getElementById('modalHeader').innerHTML = `ב${document.getElementById('routes').value}, מהתחנה ${document.getElementById('stops').value} עד תחנה ${document.getElementById('eStop').value}`
      
      document.getElementById('myModal').style.display = "block";
      document.getElementById('myModal').style.zIndex = "2"
      */
    }

    function routes(data) {
      //route_data = '';
      var routeList = [];
      for (i = 0; i < data['route_stops'].length; i++) {
        routeList.push(data["route_stops"][i]["route"]);//{'short':[data["route_stops"][i]["route"]["route_short_name"]],'long':data["route_stops"][i]["route"]["route_long_name"]};

        //route_data+=`<li><b>${data["route_stops"][i]["route"]["route_short_name"]}:</b> ${data["route_stops"][i]["route"]["route_long_name"]}</li>\n`;
      }
      return routeList;
    }

    function showRoutesListInStop() {

      /*
      stopsData = [];
      stopsData_temp = [];
      rootAllFirstStopsID = [];
      sortStops = [];
      */


      // reset old layer
      map.removeLayer(nearbyStopMarker);
      map.removeLayer(On_OffRoute);
      map.removeLayer(stopOnRoute);
      //nearbyStopMarker = L.featureGroup({}).addTo(map);
      On_OffRoute = L.featureGroup({}).addTo(map);
      stopOnRoute = L.featureGroup({}).addTo(map);

      var element_input = document.getElementById('stops');
      var element_datalist = document.getElementById('stops1');
      var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
      var val = opSelected.getAttribute('data-value');

      // show on map the start stop
      if (getOn != null) {
        //map.removeLayer(oldMarker);
        getOn.setLatLng(rootAllNearbyStopsLocation[val]).update();  // Updates your defined marker position
      } else {
        getOn = new L.Marker(rootAllNearbyStopsLocation[val], { icon: busGetOn }).bindPopup(element_input.value);
        getOn.addTo(map);
      }
      map.setView(rootAllNearbyStopsLocation[val]);


      var x = `<label for="routes">בחר קו: <input id="routes" onfocus="blur()" list="routes1" onChange="showStopsListInRoute()"> <button class="resetbutton" onclick="document.getElementById('routes').value=''">אפס</button></label>
                      <datalist name="routes" id="routes1">
                        <option value="" selected disabled hidden>בחר קו</option>`;//<option value="volvo">Volvo</option> onfocus="this.value=''"


      var n = 0;
      while (n < dataFile[val].length) {
        // split long name
        route_long_name = dataFile[val][n]["route_long_name"];
        //console.log(route_long_name);
        end = route_long_name.slice(route_long_name.indexOf(">") + 1, route_long_name.indexOf('#') - 2);
        first = route_long_name.slice(0, route_long_name.indexOf('<'));
        routeNumber = route_long_name.slice(route_long_name.indexOf('#') - 1)
        //console.log(routeNumber)



        x += `<option data-value="${dataFile[val][n]["id"]}" value="קו ${dataFile[val][n]["route_short_name"]}, מסלול ${routeNumber}">מ:${first}, לכיוון: ${end}</option>`;
        n++
      }
      x += `</datalist><br>`;
      document.getElementById('listForTest').innerHTML = x;
    }


    function showStopsListInRoute() {

      //dataFile = [];
      //stopsData = [];
      stopsData_temp = [];
      //rootAllFirstStopsID = [];
      sortStops = [];



      //var stopOnRoute = L.featureGroup().addTo(map);
      //map.removeLayer(nearbyStopMarker);


      // reset old layer
      map.removeLayer(nearbyStopMarker);
      map.removeLayer(On_OffRoute);
      map.removeLayer(stopOnRoute);
      nearbyStopMarker = L.featureGroup().addTo(map);
      On_OffRoute = L.featureGroup().addTo(map);
      stopOnRoute = L.featureGroup().addTo(map);

      var element_input = document.getElementById('routes');
      var element_datalist = document.getElementById('routes1');
      var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
      var idOfRoute = opSelected.getAttribute('data-value');

      //var idOfRoute = document.getElementById('routes').value;
      var linkRoute = `https://transit.land/api/v2/rest/routes/${idOfRoute}?apikey=iMDAuMorfb5YN90M8fmjiswA5okKN0zX&format=geojson`;
      //console.log(linkRoute);

      // Instantiate an new XHR Object
      const xhr = new XMLHttpRequest();

      // Open an obejct (GET/POST, PATH,
      // ASYN-TRUE/FALSE)
      xhr.open("GET", linkRoute, true);

      // When response is ready
      xhr.onload = function () {
        if (this.status === 200) {

          // Changing string data into JSON Object
          obj = JSON.parse(this.responseText);
          stopsData = obj["features"][0]["properties"]["route_stops"];

          var x = `<label for="endstops">בחר תחנת יעד: <input autocomplete="off" id="eStop" onfocus="blur()" list="eStop1" onChange="showButtonForCalc()"> <button class="resetbutton" onclick="document.getElementById('eStop').value=''">אפס</button></label>
                      <datalist name="eStop" id="eStop1">
                        <option value="" selected disabled hidden>בחר תחנת ירידה</option>`;// onfocus="this.value=''"


          var element_input = document.getElementById('stops');
          var element_datalist = document.getElementById('stops1');
          var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
          var tempValue1 = opSelected.getAttribute('data-value');

          firstStopID = rootAllFirstStopsID[tempValue1];

          var nearbyIcon = L.icon({
            iconUrl: 'icons8-marker-48inRoute.png',
            iconSize: [13, 13], // size of the icon
          });


          // sort the list
          sortedStops_withLine = sortStopsList(obj["features"][0]);

          var flag_firstStopID, sortStops_counter = 0, flag_firstStopID_inWithLine = 0;

          for (i = 0; i < sortedStops_withLine.length; i++) {
            if ('stop' in sortedStops_withLine[i]) {
              stop_info = sortedStops_withLine[i];
              sortStops.push(stop_info); // for storing list of stops only
              sortStops_counter++;
              if (stop_info['stop']['id'] == firstStopID) {
                flag_firstStopID = sortStops_counter;
                flag_firstStopID_inWithLine = i;
                //console.log("Start stop: " + stop_info['stop']['stop_name']);
              }
              //console.log(i + ', Name - ' + stop_info['stop']['stop_name']);
            }
          }

          //short the list from the seleced (start) stop
          sortStops.splice(0, flag_firstStopID - 1); // the (-1) for showing in the list the first stop
          sortedStops_withLine.splice(0, flag_firstStopID_inWithLine);

          // (OLD) stopsData = sortStops;
          stopsData = sortedStops_withLine;


          // show the line from the selected stop to end stop on the map
          previusCoordinates = null;
          for (index in stopsData) {
            if (!('stop' in stopsData[index])) {
              coordinates = [stopsData[index][1], stopsData[index][0]];
              if (index < stopsData.length - 1) {
                if (previusCoordinates != null) {
                  var line = new L.polyline([previusCoordinates, coordinates]);
                  stopOnRoute.addLayer(line);
                }
                previusCoordinates = coordinates;
              }
            }
          }


          //stopData replaced with sortStops
          // sortStops only contain the stops (without geometry) 
          var n = 0;
          while (n < sortStops.length - 1) {
            x += `<option data-value="${sortStops[n]["stop"]["id"]}" value="${sortStops[n]["stop"]["stop_name"]}">`;

            coordinates = [sortStops[n]["stop"]['geometry']['coordinates'][1], sortStops[n]["stop"]['geometry']['coordinates'][0]];
            coordinates2 = [sortStops[n + 1]["stop"]['geometry']['coordinates'][1], sortStops[n + 1]["stop"]['geometry']['coordinates'][0]];
            var marker = new L.Marker(coordinates, { icon: nearbyIcon }).bindPopup(sortStops[n]["stop"]['stop_name']);

            //var line = new L.polyline([coordinates, coordinates2]);
            stopOnRoute.addLayer(marker);
            //stopOnRoute.addLayer(line);

            n++;
          }
          x += `<option data-value="${sortStops[sortStops.length - 1]["stop"]["id"]}" value="${sortStops[sortStops.length - 1]["stop"]["stop_name"]}">`;

          coordinates = [sortStops[sortStops.length - 1]["stop"]['geometry']['coordinates'][1], sortStops[sortStops.length - 1]["stop"]['geometry']['coordinates'][0]];
          var marker = new L.Marker(coordinates, { icon: nearbyIcon }).bindPopup(sortStops[sortStops.length - 1]["stop"]['stop_name']);
          stopOnRoute.addLayer(marker);
          map.fitBounds(stopOnRoute.getBounds());

          x += `</datalist><br>`;

          document.getElementById('list_StopsInRoute').innerHTML = x;

        }
        else {
          alert("Something went wrong!");
        }
      }
      // At last send the request
      xhr.send();

    }

    // show button
    // show on map start\end stops
    // short the list
    function showButtonForCalc() {
      document.getElementById('button_startCalc').innerHTML =
        `<div hidden><input  id="date" type="date" name="task_date" /> :תאריך<br></div>` + // the date is hidden (not needed)
        `<input id="time" type="time" name="task_time" /> :שעה
                    <br>
                    <br>
                    <button class="w3-btn w3-blue w3-hover-light-grey" onclick="calculatePerFullRoute()">התחל לחשב</button>
                    <br>`;

      var date = new Date();

      var day = date.getDate(),
        month = date.getMonth() + 1,
        year = date.getFullYear(),
        hour = date.getHours(),
        min = date.getMinutes();

      month = (month < 10 ? "0" : "") + month;
      day = (day < 10 ? "0" : "") + day;
      hour = (hour < 10 ? "0" : "") + hour;
      min = (min < 10 ? "0" : "") + min;

      var today = year + "-" + month + "-" + day,
        displayTime = hour + ":" + min;

      document.getElementById('date').value = today;
      document.getElementById("time").value = displayTime;
      // remove old route
      map.removeLayer(On_OffRoute);
      On_OffRoute = L.featureGroup().addTo(map);


      var element_input = document.getElementById('eStop');
      var element_datalist = document.getElementById('eStop1');
      var opSelected = element_datalist.querySelector(`[value="${element_input.value}"]`);
      lastStopID = opSelected.getAttribute('data-value');


      var previusCoordinates = null;
      for (stopindex in stopsData) {
        stopsData_temp.push(stopsData[stopindex]);
        if ('stop' in stopsData[stopindex]) {
          // show marker for end stop
          if (stopsData[stopindex]['stop']['id'] == lastStopID) {
            endStopLocation = stopsData[stopindex]["stop"]["geometry"]["coordinates"];
            coordinates = [endStopLocation[1], endStopLocation[0]];
            var getOff = new L.Marker(coordinates, { icon: busGetOff }).bindPopup(stopsData[stopindex]["stop"]['stop_name']);
            On_OffRoute.addLayer(getOff);
            break; // stop pushing when end-stop founded
          }
        }
        else {
          coordinates = [stopsData[stopindex][1], stopsData[stopindex][0]];
          if (previusCoordinates != null && stopindex < stopsData.length - 1) {
            var line = new L.polyline([previusCoordinates, coordinates]);
            On_OffRoute.addLayer(line);
          }
          previusCoordinates = coordinates;
        }
      }
      //console.log('Sum mini location (geometry): ' + stopsData_temp.length);



      map.fitBounds(On_OffRoute.getBounds());
      // remove all stop
      map.removeLayer(stopOnRoute);
    }

    function findNearStops() {
      //show section
      document.getElementById('section2').style.display = 'block';

      // reset old layer
      map.removeLayer(nearbyStopMarker);
      map.removeLayer(On_OffRoute);
      map.removeLayer(stopOnRoute);
      nearbyStopMarker = L.featureGroup().addTo(map);
      On_OffRoute = L.featureGroup().addTo(map);
      stopOnRoute = L.featureGroup().addTo(map);

      if (getOn != null) {
        map.removeLayer(getOn);
        getOn = null;
      }

      // reset old data files
      dataFile = [];
      stopsData = [];
      stopsData_temp = [];
      rootAllFirstStopsID = [];
      rootAllNearbyStopsLocation = [];
      sortStops = [];

      var lat = document.getElementById('lat').value;
      var lon = document.getElementById('lon').value;
      var radius = document.getElementById('radius').value * 10;
      var url = 'https://transit.land/api/v2/rest/stops?apikey=iMDAuMorfb5YN90M8fmjiswA5okKN0zX&feed_onestop_id=f-sv-גלים~מועצהאזוריתגולן~אפיקים~דןצפון~דןבדרום~דןבארשבע~ירושלים&lat=' + lat + '&lon=' + lon + '&radius=' + radius + '&format=geojson';

      // Instantiate an new XHR Object
      const xhr = new XMLHttpRequest();

      // Open an obejct (GET/POST, PATH,
      // ASYN-TRUE/FALSE)
      xhr.open("GET", url, true);

      // When response is ready
      xhr.onload = function () {
        if (this.status === 200) {

          // Changing string data into JSON Object
          obj = JSON.parse(this.responseText);

          // Getting the ul element
          let list = document.getElementById("list");
          str = `<label for="stops"><label type="text">בחר תחנת מוצא: </label><input list="stops1" inputmode=“none” autocomplete="off" id="stops" onChange="showRoutesListInStop()"> <button class="resetbutton" onclick="document.getElementById('stops').value=''">אפס</button></label>
                          <datalist name="stops" id="stops1">
                            <option value="" selected disabled hidden>בחר תחנת עלייה</option>`; //onfocus="this.value=''" 

                            // check if works - class="hidekeyboard" intead onfocus="blur()"

          var n = 0;
          var stop_code = [];
          var stop_names = [];
          stop_name_counter = 1

          var nearbyIcon = L.icon({
            iconUrl: 'icons8-bus-48.png',
            iconSize: [20, 20], // size of the icon
          });


          //console.log('stops near by: ' + obj['features'].length);
          while (n < obj['features'].length) {
            data = obj['features'][n]['properties'];
            coordinates = [data['geometry']['coordinates'][1], data['geometry']['coordinates'][0]];
            //console.log(coordinates)

            // when the stop already in the list (רציפים)
            if (stop_code.includes(data["stop_code"])) {
              //console.log("exist - " + data["stop_code"]);
            }
            else {

              //if the same name shown couple of time but in diffrent stops
              stop_name_temp = data['stop_name']
              if (stop_names.includes(stop_name_temp)) {
                stop_name_temp += ` #${stop_name_counter}`
                stop_name_counter++
              }

              str += `<option data-value=${data['stop_code']} value="${stop_name_temp}">${data['stop_code']}</option>`;
              rootAllFirstStopsID[data['stop_code']] = data['id'];

              stop_code.push(data["stop_code"]);
              stop_names.push(stop_name_temp)
              //console.log(stop_name_temp);


              rootAllNearbyStopsLocation[data['stop_code']] = coordinates;

              var marker = new L.Marker(coordinates, { icon: nearbyIcon }).bindPopup(data['stop_name']);
              nearbyStopMarker.addLayer(marker);

              //nearbyStopMarker.push(L.marker(coordinates).bindPopup('This is Littleton, CO.'));
            }

            if (dataFile[data['stop_code']] == null) {
              dataFile[data['stop_code']] = [];
            }
            dataFile[data['stop_code']] = [...dataFile[data['stop_code']], ...routes(data)]; //n+1 is the kay, value is the return array

            n++;
          }

          str += `</datalist><br>`;
          //str += `<label id="val_num"></label>`;

          //var overlay = {'markers': nearbyStopMarker};
          //L.layerGroup(nearbyStopMarker);
          //L.control.layers(null,overlay).addTo(map);

          //nearbyStopMarker.addLayer(new L.Marker(markers[n-1]));

          map.fitBounds(nearbyStopMarker.getBounds());



          if (n != 0) {
            document.getElementById('collapse_head').innerHTML = 'תחנות קרובות:';
            list.innerHTML = str;
          }
          else {
            alert("אין תחנות באיזור!\nנסה להגדיל ידנית את הטווח חיפוש.")
          }

        }
        else {
          alert("משהו נכשל!");
        }
      }

      // At last send the request
      xhr.send();


      var section2 = document.getElementById("section2");

      section2.scrollIntoView({
        behavior: "smooth",
        block: "end",
        inline: "nearest"
      });
    };


    window.onload = function() {
      getLocation()
    };


    /*
    window.onload = () => {
      'use strict';
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          // navigator.serviceWorker.register("/flutter_service_worker.js");
          navigator.serviceWorker.register("./sw.js");
        });
      }
    }

    */
  </script>


  </div>

  <script src="languages.js"></script>
  <!-- Script for Sidebar, Tabs, Accordions, Progress bars and slideshows -->
  <script>

    function loadTranslate() {
      var LngObject = JSON.parse(data); // from "languages.js"
      var translate = new Translate();
      var currentLng = document.getElementById('lang').value;//'fr'\'en'
      var attributeName = 'data-lang';
      translate.init(attributeName, currentLng, LngObject);
      translate.process();
    }

    // Source: http://stackoverflow.com/questions/497790
    var dates = {
      convert: function (d) {
        // Converts the date in d to a date-object. The input can be:
        //   a date object: returned without modification
        //  an array      : Interpreted as [year,month,day]. NOTE: month is 0-11.
        //   a number     : Interpreted as number of milliseconds
        //                  since 1 Jan 1970 (a timestamp) 
        //   a string     : Any format supported by the javascript engine, like
        //                  "YYYY/MM/DD", "MM/DD/YYYY", "Jan 31 2009" etc.
        //  an object     : Interpreted as an object with year, month and date
        //                  attributes.  **NOTE** month is 0-11.
        return (
          d.constructor === Date ? d :
            d.constructor === Array ? new Date(d[0], d[1], d[2]) :
              d.constructor === Number ? new Date(d) :
                d.constructor === String ? new Date(d) :
                  typeof d === "object" ? new Date(d.year, d.month, d.date) :
                    NaN
        );
      },
      compare: function (a, b) {
        // Compare two dates (could be of any type supported by the convert
        // function above) and returns:
        //  -1 : if a < b
        //   0 : if a = b
        //   1 : if a > b
        // NaN : if a or b is an illegal date
        // NOTE: The code inside isFinite does an assignment (=).
        return (
          isFinite(a = this.convert(a).valueOf()) &&
            isFinite(b = this.convert(b).valueOf()) ?
            (a > b) - (a < b) :
            NaN
        );
      },
      inRange: function (d, start, end) {
        // Checks if date in d is between dates in start and end.
        // Returns a boolean or NaN:
        //    true  : if d is between start and end (inclusive)
        //    false : if d is before start or after end
        //    NaN   : if one or more of the dates is illegal.
        // NOTE: The code inside isFinite does an assignment (=).
        return (
          isFinite(d = this.convert(d).valueOf()) &&
            isFinite(start = this.convert(start).valueOf()) &&
            isFinite(end = this.convert(end).valueOf()) ?
            start <= d && d <= end :
            NaN
        );
      }
    }

    function isDayNow(StopLocation, customDate) {

      sunCalcTime = SunCalc.getTimes(/*Date*/ customDate,
                                  /*Number*/ StopLocation[0],
                                  /*Number*/ StopLocation[1],
                                  /*Number (default=0)*/ 0);

      startTime = sunCalcTime['sunriseEnd']
      endTime = sunCalcTime['sunsetStart']

      return dates.inRange(customDate, startTime, endTime);
    }

    /* Side navigation
    function w3_open() {
      var x = document.getElementById("mySidebar");
      x.style.width = "100%";
      x.style.fontSize = "40px";
      x.style.paddingTop = "10%";
      x.style.display = "block";
    }
    function w3_close() {
      document.getElementById("mySidebar").style.display = "none";
    }
    

    // Tabs
    function openCity(evt, cityName) {
      var i;
      var x = document.getElementsByClassName("city");
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
      var activebtn = document.getElementsByClassName("testbtn");
      for (i = 0; i < x.length; i++) {
        activebtn[i].className = activebtn[i].className.replace(" w3-dark-grey", "");
      }
      document.getElementById(cityName).style.display = "block";
      evt.currentTarget.className += " w3-dark-grey";
    }

    var mybtn = document.getElementsByClassName("testbtn")[0];
    mybtn.click();

    // Accordions
    function myAccFunc(id) {
      var x = document.getElementById(id);
      if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
      } else {
        x.className = x.className.replace(" w3-show", "");
      }
    }

    // Slideshows
    var slideIndex = 1;

    function plusDivs(n) {
      slideIndex = slideIndex + n;
      showDivs(slideIndex);
    }

    function showDivs(n) {
      var x = document.getElementsByClassName("mySlides");
      if (n > x.length) { slideIndex = 1 }
      if (n < 1) { slideIndex = x.length };
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
      x[slideIndex - 1].style.display = "block";
    }

    showDivs(1);

    // Progress Bars
    function move() {
      var elem = document.getElementById("myBar");
      var width = 5;
      var id = setInterval(frame, 10);
      function frame() {
        if (width == 100) {
          clearInterval(id);
        } else {
          width++;
          elem.style.width = width + '%';
          elem.innerHTML = width * 1 + '%';
        }
      }
    }
    */
  </script>

</body>

</html>